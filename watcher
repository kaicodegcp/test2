Step-by-Step Shell Script: deploy-cert-watcher.sh
bash
Copy
Edit
#!/bin/bash

# Config
CERT_URL="https://www.artifrepository.citigroup.net/artifactory/generic-cto-dev-local/cate-bigdata-165345/docker/domain.crt"
LOCAL_IMAGE="sd-wv58-kflz.nam.nsroot.net:5000/cdp-private/cloudera/cdp-gateway:2.1.0-b288"
DAEMONSET_FILE="/tmp/cert-watcher-daemonset.yaml"

# Worker nodes (update if needed)
NODES=(
  bdgtr051x03h5.nam.nsroot.net
  dfgtr040x12h5.nam.nsroot.net
  dfgtr042x28h5.nam.nsroot.net
  dfgtr114x11h5.nam.nsroot.net
  dfgtr162x01t2.nam.nsroot.net
  ezgtr084x01t1.nam.nsroot.net
  ezgtr129x27t2.nam.nsroot.net
)

echo "[STEP 1] Labeling all worker nodes with copy-cert=true"
for NODE in "${NODES[@]}"; do
  oc label node "$NODE" copy-cert=true --overwrite
done

echo "[STEP 2] Creating DaemonSet YAML"
cat <<EOF > "$DAEMONSET_FILE"
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: domain-cert-watcher
  namespace: openshift-config
spec:
  selector:
    matchLabels:
      app: domain-cert-watcher
  template:
    metadata:
      labels:
        app: domain-cert-watcher
    spec:
      tolerations:
      - operator: Exists
      nodeSelector:
        copy-cert: "true"
      hostPID: true
      hostNetwork: true
      containers:
      - name: cert-watcher
        image: ${LOCAL_IMAGE}
        securityContext:
          privileged: true
        command:
        - /bin/bash
        - -c
        - |
          echo "[WATCHER] Starting cert monitor..."
          while true; do
            if [ ! -f /host/etc/pki/ca-trust/source/anchors/domain.crt ]; then
              echo "[WATCHER] domain.crt missing â€” restoring..."
              curl -s -o /host/etc/pki/ca-trust/source/anchors/domain.crt ${CERT_URL}
              chroot /host update-ca-trust extract
              echo "[WATCHER] domain.crt restored."
            else
              echo "[WATCHER] domain.crt present."
            fi
            sleep 300
          done
        volumeMounts:
        - name: host-root
          mountPath: /host
        - name: ca-cert-dir
          mountPath: /host/etc/pki/ca-trust/source/anchors
        - name: cert
          mountPath: /certs
      volumes:
      - name: host-root
        hostPath:
          path: /
      - name: ca-cert-dir
        hostPath:
          path: /etc/pki/ca-trust/source/anchors
      - name: cert
        emptyDir: {}
EOF

echo "[STEP 3] Applying DaemonSet"
oc apply -f "$DAEMONSET_FILE"

echo "[DONE] Cert watcher deployed to all worker nodes."
ðŸ”§ To Use This
Save it:

bash
Copy
Edit
vi deploy-cert-watcher.sh
chmod +x deploy-cert-watcher.sh
Run it:

bash
Copy
Edit
./deploy-cert-watcher.sh
